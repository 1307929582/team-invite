#!/bin/bash

# ChatGPT Team Manager CLI
# 用法: team [命令]

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

COMPOSE_FILE="docker-compose.postgres.yml"
PROJECT_DIR=$(dirname "$(readlink -f "$0")")

show_logo() {
    echo -e "${CYAN}"
    echo "  ╔════════════════════════════════════════╗"
    echo "  ║   ChatGPT Team Manager CLI             ║"
    echo "  ╚════════════════════════════════════════╝"
    echo -e "${NC}"
}

show_menu() {
    echo -e "${GREEN}请选择操作:${NC}"
    echo ""
    echo -e "  ${YELLOW}1)${NC} 查看状态      - 查看服务运行状态"
    echo -e "  ${YELLOW}2)${NC} 启动服务      - 启动所有服务"
    echo -e "  ${YELLOW}3)${NC} 停止服务      - 停止所有服务"
    echo -e "  ${YELLOW}4)${NC} 重启服务      - 重启所有服务"
    echo -e "  ${YELLOW}5)${NC} 更新系统      - 拉取最新代码并重新构建"
    echo -e "  ${YELLOW}6)${NC} 查看日志      - 查看后端日志"
    echo -e "  ${YELLOW}7)${NC} 查看前端日志  - 查看前端日志"
    echo -e "  ${YELLOW}8)${NC} 进入后端容器  - 进入后端 Shell"
    echo -e "  ${YELLOW}9)${NC} 数据库备份    - 备份 PostgreSQL 数据库"
    echo -e "  ${YELLOW}10)${NC} 清理缓存     - 清理 Redis 缓存"
    echo -e "  ${YELLOW}0)${NC} 退出"
    echo ""
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}错误: Docker 未安装${NC}"
        exit 1
    fi
    if ! docker compose version &> /dev/null; then
        echo -e "${RED}错误: Docker Compose 未安装${NC}"
        exit 1
    fi
}

status() {
    cd "$PROJECT_DIR"
    
    # 前端
    if docker compose -f $COMPOSE_FILE ps frontend 2>/dev/null | grep -q "Up"; then
        echo -e "前端：${GREEN}运行${NC}"
    else
        echo -e "前端：${RED}未运行${NC}"
    fi
    
    # 后端
    if docker compose -f $COMPOSE_FILE ps backend 2>/dev/null | grep -q "Up"; then
        echo -e "后端：${GREEN}运行${NC}"
    else
        echo -e "后端：${RED}未运行${NC}"
    fi
    
    # 数据库
    if docker compose -f $COMPOSE_FILE ps db 2>/dev/null | grep -q "Up"; then
        echo -e "数据库：${GREEN}运行${NC}"
    else
        echo -e "数据库：${RED}未运行${NC}"
    fi
    
    # Redis
    if docker compose -f $COMPOSE_FILE ps redis 2>/dev/null | grep -q "Up"; then
        echo -e "缓存：${GREEN}运行${NC}"
    else
        echo -e "缓存：${RED}未运行${NC}"
    fi
}

start() {
    echo -e "${GREEN}启动服务...${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE up -d
    echo -e "${GREEN}服务已启动${NC}"
}

stop() {
    echo -e "${YELLOW}停止服务...${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE down
    echo -e "${GREEN}服务已停止${NC}"
}

restart() {
    echo -e "${YELLOW}重启服务...${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE restart
    echo -e "${GREEN}服务已重启${NC}"
}

update() {
    echo -e "${CYAN}开始更新...${NC}"
    cd "$PROJECT_DIR"
    
    echo -e "${BLUE}1. 拉取最新代码...${NC}"
    git pull
    
    echo -e "${BLUE}2. 重新构建并启动...${NC}"
    docker compose -f $COMPOSE_FILE up -d --build
    
    echo -e "${GREEN}更新完成！${NC}"
}

logs_backend() {
    echo -e "${BLUE}后端日志 (Ctrl+C 退出):${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE logs -f backend
}

logs_frontend() {
    echo -e "${BLUE}前端日志 (Ctrl+C 退出):${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE logs -f frontend
}

shell_backend() {
    echo -e "${BLUE}进入后端容器...${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE exec backend sh
}

backup_db() {
    echo -e "${CYAN}备份数据库...${NC}"
    cd "$PROJECT_DIR"
    BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
    docker compose -f $COMPOSE_FILE exec -T postgres pg_dump -U postgres team_manager > "$BACKUP_FILE"
    echo -e "${GREEN}数据库已备份到: $BACKUP_FILE${NC}"
}

clear_cache() {
    echo -e "${YELLOW}清理 Redis 缓存...${NC}"
    cd "$PROJECT_DIR"
    docker compose -f $COMPOSE_FILE exec redis redis-cli FLUSHALL
    echo -e "${GREEN}缓存已清理${NC}"
}

# 主逻辑
check_docker

# 如果有参数，直接执行对应命令
case "$1" in
    status|s)
        status
        exit 0
        ;;
    start)
        start
        exit 0
        ;;
    stop)
        stop
        exit 0
        ;;
    restart|r)
        restart
        exit 0
        ;;
    update|u)
        update
        exit 0
        ;;
    logs|l)
        logs_backend
        exit 0
        ;;
    logs-frontend|lf)
        logs_frontend
        exit 0
        ;;
    shell|sh)
        shell_backend
        exit 0
        ;;
    backup|b)
        backup_db
        exit 0
        ;;
    cache|c)
        clear_cache
        exit 0
        ;;
    help|h|--help|-h)
        show_logo
        echo -e "${GREEN}用法: team [命令]${NC}"
        echo ""
        echo "命令:"
        echo "  status, s      查看服务状态"
        echo "  start          启动服务"
        echo "  stop           停止服务"
        echo "  restart, r     重启服务"
        echo "  update, u      更新系统"
        echo "  logs, l        查看后端日志"
        echo "  logs-frontend, lf  查看前端日志"
        echo "  shell, sh      进入后端容器"
        echo "  backup, b      备份数据库"
        echo "  cache, c       清理缓存"
        echo "  help, h        显示帮助"
        echo ""
        exit 0
        ;;
esac

# 无参数时显示交互菜单
show_logo

while true; do
    show_menu
    read -p "请输入选项 [0-10]: " choice
    echo ""
    
    case $choice in
        1) status ;;
        2) start ;;
        3) stop ;;
        4) restart ;;
        5) update ;;
        6) logs_backend ;;
        7) logs_frontend ;;
        8) shell_backend ;;
        9) backup_db ;;
        10) clear_cache ;;
        0) 
            echo -e "${GREEN}再见！${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选项，请重新选择${NC}"
            ;;
    esac
    
    echo ""
    read -p "按回车继续..."
    clear
    show_logo
done
